<!-- Start Shop Services Area -->
<section class="shop-services section home">
		<div class="container">
			<div class="row">
				<div class="col-lg-3 col-md-6 col-12">
					<!-- Start Single Service -->
					<div class="single-service">
						<i class="ti-rocket"></i>
						<h4>Free shiping</h4>
						<p>Orders over $100</p>
					</div>
					<!-- End Single Service -->
				</div>
				<div class="col-lg-3 col-md-6 col-12">
					<!-- Start Single Service -->
					<div class="single-service">
						<i class="ti-reload"></i>
						<h4>Free Return</h4>
						<p>Within 30 days returns</p>
					</div>
					<!-- End Single Service -->
				</div>
				<div class="col-lg-3 col-md-6 col-12">
					<!-- Start Single Service -->
					<div class="single-service">
						<i class="ti-lock"></i>
						<h4>Sucure Payment</h4>
						<p>100% secure payment</p>
					</div>
					<!-- End Single Service -->
				</div>
				<div class="col-lg-3 col-md-6 col-12">
					<!-- Start Single Service -->
					<div class="single-service">
						<i class="ti-tag"></i>
						<h4>Best Peice</h4>
						<p>Guaranteed price</p>
					</div>
					<!-- End Single Service -->
				</div>
			</div>
		</div>
	</section>
	<!-- End Shop Services Area -->
	
	<!-- Start Shop Newsletter  -->
	<section class="shop-newsletter section">
		<div class="container">
			<div class="inner-top">
				<div class="row">
					<div class="col-lg-8 offset-lg-2 col-12">
						<!-- Start Newsletter Inner -->
						<div class="inner">
							<h4>Newsletter</h4>
							<p> Subscribe to our newsletter and get <span>10%</span> off your first purchase</p>
							<form action="mail/mail.php" method="get" target="_blank" class="newsletter-inner">
								<input name="EMAIL" placeholder="Your email address" required="" type="email">
								<button class="btn">Subscribe</button>
							</form>
						</div>
						<!-- End Newsletter Inner -->
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- End Shop Newsletter -->
	
	<?php include 'home/quickView.php'; ?>
	
	<!-- Start Footer Area -->
	<footer class="footer">
		<!-- Footer Top -->
		<div class="footer-top section">
			<div class="container">
				<div class="row">
					<div class="col-lg-5 col-md-6 col-12">
						<!-- Single Widget -->
						<div class="single-footer about">
							<div class="logo">
								<a href="index.html"><img src="images/logo2.png" alt="#"></a>
							</div>
							<p class="text">Praesent dapibus, neque id cursus ucibus, tortor neque egestas augue,  magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus.</p>
							<p class="call">Got Question? Call us 24/7<span><a href="tel:123456789">+0123 456 789</a></span></p>
						</div>
						<!-- End Single Widget -->
					</div>
					<div class="col-lg-2 col-md-6 col-12">
						<!-- Single Widget -->
						<div class="single-footer links">
							<h4>Information</h4>
							<ul>
								<li><a href="#">About Us</a></li>
								<li><a href="#">Faq</a></li>
								<li><a href="#">Terms & Conditions</a></li>
								<li><a href="#">Contact Us</a></li>
								<li><a href="#">Help</a></li>
							</ul>
						</div>
						<!-- End Single Widget -->
					</div>
					<div class="col-lg-2 col-md-6 col-12">
						<!-- Single Widget -->
						<div class="single-footer links">
							<h4>Customer Service</h4>
							<ul>
								<li><a href="#">Payment Methods</a></li>
								<li><a href="#">Money-back</a></li>
								<li><a href="#">Returns</a></li>
								<li><a href="#">Shipping</a></li>
								<li><a href="#">Privacy Policy</a></li>
							</ul>
						</div>
						<!-- End Single Widget -->
					</div>
					<div class="col-lg-3 col-md-6 col-12">
						<!-- Single Widget -->
						<div class="single-footer social">
							<h4>Get In Tuch</h4>
							<!-- Single Widget -->
							<div class="contact">
								<ul>
									<li>NO. 342 - London Oxford Street.</li>
									<li>012 United Kingdom.</li>
									<li>info@eshop.com</li>
									<li>+032 3456 7890</li>
								</ul>
							</div>
							<!-- End Single Widget -->
							<ul>
								<li><a href="#"><i class="ti-facebook"></i></a></li>
								<li><a href="#"><i class="ti-twitter"></i></a></li>
								<li><a href="#"><i class="ti-flickr"></i></a></li>
								<li><a href="#"><i class="ti-instagram"></i></a></li>
							</ul>
						</div>
						<!-- End Single Widget -->
					</div>
				</div>
			</div>
		</div>
		<!-- End Footer Top -->
		<div class="copyright">
			<div class="container">
				<div class="inner">
					<div class="row">
						<div class="col-lg-6 col-12">
							<div class="left">
								<p>Copyright © 2020 <a href="http://www.wpthemesgrid.com" target="_blank">Wpthemesgrid</a>  -  All Rights Reserved.</p>
							</div>
						</div>
						<div class="col-lg-6 col-12">
							<div class="right">
								<img src="images/payments.png" alt="#">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</footer>
	<!-- /End Footer Area -->
	<!-- Jquery -->
    <script src="../js/jquery.min.js"></script>
    <script src="../js/jquery-migrate-3.0.0.js"></script>
	<script src="../js/jquery-ui.min.js"></script>
	<!-- Popper JS -->
	<script src="../js/popper.min.js"></script>
	<!-- Bootstrap JS -->
	<script src="../js/bootstrap.min.js"></script>
	<!-- Color JS -->
	<script src="../js/colors.js"></script>
	<!-- Slicknav JS -->
	<script src="../js/slicknav.min.js"></script>
	<!-- Owl Carousel JS -->
	<script src="../js/owl-carousel.js"></script>
	<!-- Magnific Popup JS -->
	<script src="../js/magnific-popup.js"></script>
	<!-- Fancybox JS -->
	<script src="../js/facnybox.min.js"></script>
	<!-- Waypoints JS -->
	<script src="../js/waypoints.min.js"></script>
	<!-- Countdown JS -->
	<script src="../js/finalcountdown.min.js"></script>
	<!-- Ytplayer JS -->
	<script src="../js/ytplayer.min.js"></script>
	<!-- Nice Select JS -->
	<script src="../js/nicesellect.js"></script>
	<!-- Flex Slider JS -->
	<script src="../js/flex-slider.js"></script>
	<!-- ScrollUp JS -->
	<script src="../js/scrollup.js"></script>
	<!-- Onepage Nav JS -->
	<script src="../js/onepage-nav.min.js"></script>
	<!-- Easing JS -->
	<script src="../js/easing.js"></script>
	<!-- Sweet alert 2-->
	<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<!-- Active JS -->
	<script src="../js/active.js"></script>
	<script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
	<script>
	var rating_data = 0;
	$(document).on('mouseenter', '.submit_star', function(){

    var rating = $(this).data('rating');

    // reset_background();

    for(var count = 1; count <= rating; count++)
    {

        $('#submit_star_'+count).addClass('text-warning');

    }

});

function reset_background()
{
    for(var count = 1; count <= 5; count++)
    {

        $('#submit_star_'+count).addClass('star-light');

        $('#submit_star_'+count).removeClass('text-warning');

    }
}

$(document).on('mouseleave', '.submit_star', function(){

    reset_background();

    for(var count = 1; count <= rating_data; count++)
    {

        $('#submit_star_'+count).removeClass('star-light');

        $('#submit_star_'+count).addClass('text-warning');
    }

});

$(document).on('click', '.submit_star', function(){
    rating_data = $(this).data('rating');
});
$('#add_review').click(function(){

var user_id = $('#user_id').val();
var user_review = $('#user_review').val();
var product_id = $('#product_id').val();

if(user_review == '')
{
	alert("Please fill in the input field");
	return false;
}
else
{
	$.ajax({
		url:"../controller/submit_rating.php",
		method:"POST",
		data:{rating_data:rating_data, user_id:user_id, user_review:user_review, product_id:product_id},
		success:function(data)
		{
			// load_rating_data();
			alert(data);
		}
	})
	// location.reload();
}
});
load_rating_data();
var globalData;  // Biến toàn cục để lưu trữ dữ liệu
function load_rating_data(){
var username = $('#user_name').val();
var product_id = $('#product_id').val();
console.log(product_id);
$.ajax({
url:"../controller/submit_rating.php",
method:"POST",
data:{action: product_id},
dataType:"JSON",
success:function(data)
{
	console.log(data);
	globalData = data;  // Lưu dữ liệu vào biến toàn cục
	$('#average_rating').text(data.average_rating);
        $('#total_review').text(data.total_review);
        var count_star = 0;
        // $('.main_star').each(function(){
        //     count_star++;
        //     if(Math.ceil(data.average_rating) >= count_star)
        //     {
        //         $(this).addClass('text-warning');
        //         $(this).addClass('star-light');
        //     }
        // });
        $('#total_five_star_review').text(data.five_star_review);

        $('#total_four_star_review').text(data.four_star_review);

        $('#total_three_star_review').text(data.three_star_review);

        $('#total_two_star_review').text(data.two_star_review);

        $('#total_one_star_review').text(data.one_star_review);
		if(data.review_data.length > 0)
        {
            var html = '';
            for (var count = 0; count < data.review_data.length; count++) {
            html += '<div class="review-item">';
            html += '<div class="username">' + data.review_data[count].username.charAt(0).toUpperCase() + '</div>';
            html += '<div class="review-info">';
            html += '<div class="stars">';
            // Display star ratings
            for (var star = 1; star <= 5; star++) {
                var class_name = (data.review_data[count].rating >= star) ? 'fa fa-star star-active' : 'fa fa-star-o';
                html += '<i class="' + class_name + '"></i>';
            }
            var commentId = data.review_data[count].id; 
            var productId = data.review_data[count].id_product;
            html += '</div>';
            var userReview = data.review_data[count].user_review;
            var displayReview = userReview;
            if (userReview.length > 200) {
            displayReview = userReview.substring(0, 200) + '... <a href="" onclick="toggleReview(' + count + '); return false;">Đọc tiếp</a>';
            }
            html += '<p id="review-text-' + count + '" class="review-text short-text">' + displayReview + '</p>';
            html += '<p class="review-timestamp">' + data.review_data[count].datetime + '</p>';
			if(username === data.review_data[count].username){
			html += '<a onclick="return confirm(\'Bạn có muốn xóa bình luận này không?\');" href="index.php?id='+commentId+'&id_product='+ productId+'&act=del_bl" class="delete-review" data-index="'+count+'" >Delete</a>';
			}else {
				console.log(user_id);
				console.log(data.review_data[count].user_id)
    console.log('User IDs do not match. Not adding delete button.');
}
            html += '</div>';
            html += '</div>';
}
            $('#review_content').html(html);
            
        }

}

})
}
// Readmore and readless
function toggleReview(count) {
    var userReview = globalData.review_data[count].user_review;
    var reviewText = $('#review-text-' + count);
    var shortReview = userReview.substring(0, 200) + '...';
    var readMoreLink = '<a href="#" onclick="toggleReview(' + count + '); return false;" class="read-more-link">Đọc tiếp</a>';
    var readLessLink = '<a href="#" onclick="toggleReview(' + count + '); return false;" class="read-less-link">Thu gọn</a>';
    if (reviewText.hasClass('short-text')) {
        // Lấy nội dung đầy đủ và gán vào thẻ p
        reviewText.html(userReview);
        reviewText.removeClass('short-text').addClass('full-text');
        // Thêm nút "Read less" và xóa nút "Read more"
        reviewText.next('.read-more-link').remove();
        if (!reviewText.hasClass('read-less-link')) {
            // Dùng after để readLessLink nằm ngoài thẻ p
            reviewText.after(readLessLink);
        }
    } else {
        // Lấy nội dung cắt ngắn và gán vào thẻ p
        reviewText.html(shortReview);
        reviewText.removeClass('full-text').addClass('short-text');
        // Thêm nút "Read more" và xóa nút "Read less"
        reviewText.next('.read-less-link').remove();
        if (!reviewText.hasClass('read-more-link')) {
            // dùng append để add readMorelink nằng trong thẻ p
            reviewText.append(readMoreLink);
        }
    }
}
// Choose the image to display
const imgs = document.querySelectorAll('.img-select a');
const imgBtns = [...imgs];
let imgId = 1;

imgBtns.forEach((imgItem) => {
    imgItem.addEventListener('click', (event) => {
        event.preventDefault();
        imgId = imgItem.dataset.id;
        slideImage();
    });
});
function slideImage(){
    const displayWidth = document.querySelector('.img-showcase img:first-child').clientWidth;

    document.querySelector('.img-showcase').style.transform = `translateX(${- (imgId - 1) * displayWidth}px)`;
}

window.addEventListener('resize', slideImage);
		 // Lấy id sản phẩm
		 $('.view-detail').click(function() {
		// Lấy id sản phẩm
		var productId = $(this).data('id');
		// alert(productId);
		// Gọi ajax
		$.ajax({
		url: '../controller/show-detail.php',
		method: 'POST',
		data: {id: productId},
		success: function(response) {
			// Xử lý kết quả trả về 
			$('.modal-body').html(response);
			$('#exampleModal').modal('show');
		}
		});

		});

const searchInput = $('input[name="search"]');
console.log(searchInput);
// Search result button
const searchResultsContainer = $('.search-results');
$(document).ready(function () {
    searchInput.on('input', function () {
        const query = $(this).val().trim();
		console.log(query);
        if (query === '') {
            // Xử lý khi trường tìm kiếm rỗng
            searchResultsContainer.empty();
            return;
        }
    $.ajax({
    url: '../views/indexProduct.php', // Đường dẫn tới tệp xử lý tìm kiếm
    type: 'GET',
    data: { search: query },
    dataType: "JSON", // Sửa thành search
    success: function (data) {
        console.log(data);
        // Xử lý dữ liệu trả về từ server
        if (data.length > 0) {
            let html = '<ul class="search-results">';
            data.forEach(product => {
                html += '<li class="search-result-item">';
				html += '<a class="searchPro" href="./indexProdetail.php?id=' + product.product_id + '&act=loadOne&name=' + product.category_name + '">' + product.product_name + '</a>';
                html += '<div class="product-contents">';
				html += '<div class="product-image"><img width="50" height="50" src="../images/' + product.category_name + '/' + product.product_image + '" alt="' + product.product_name + '"></div>';
                html += '<div class="search-info">';
				html += '<span class="product-name"><a href="./indexProdetail.php?id=' + product.product_id + '&act=loadOne&name=' + product.category_name + '">' + product.product_name + '</a></span>';
                html += '<span class="product-price">' + product.product_price + "VNĐ" + '</span>';
                html += '</div>';
                html += '</div>';
                html += '</a>';
                html += '</li>';
            });
            html += '</ul>';
            searchResultsContainer.html(html);
        } else {
            searchResultsContainer.html('<p>Không tìm thấy kết quả.</p>');
        }
    },
    error: function (error) {
        console.log("Error:", error);
    }
});
});
});
// Add to cart
$(".buy-button").click(function (e) {
e.preventDefault();
var productId = $(this).data('product-id');
var productName = $(this).data('product-name');
var productImage = $(this).data('product-image');
var productQty = $(this).data('product-qty');
var numberPro =1;
var productPrice = $(this).data('product-price');
console.log(productId,productName,productImage,productQty,productPrice,numberPro);
	$.ajax({
        url: '../controller/addtocart.php',
		method: 'POST',
        data: {
            productId: productId,
            productName: productName,
            productImage: productImage,
            productQty: productQty,
			numberPro: numberPro,
			productPrice: productPrice
        },
        success: function (response) {
                    // Xử lý dữ liệu nhận được từ server ở đây
					alert("Product added successfully");
					location.reload();
            console.log(response);
                    // Thực hiện các thao tác khác tùy thuộc vào dữ liệu nhận được
        },
        error: function (error) {
        	console.error('Error:', error);
        }
    });
});
$(".update-button").click(function (e) {
    e.preventDefault();
    var cartItems = [];
    $('tbody tr').each(function () {
        var tr = $(this);
        var productId = tr.find('.product_id').val();
        var productPrice = tr.find('.price span').text().replace(',', '').replace('VNĐ', '');
        var productName = tr.find('.product_name').val();
        var productImage = tr.find('.product_image').val();
        var inputValue = tr.find('.input-num').val();
        var productQuantity = tr.find('[name="input-qty"]').val();
        var totalProduct = tr.find('.productQty').val();
        // Calculate newTotalProduct based on inputValue and productQuantity
        var newTotalProduct;
        if (parseInt(inputValue) > parseInt(productQuantity)) {
            var newValue = parseInt(inputValue) - parseInt(productQuantity);
            newTotalProduct = parseInt(totalProduct) - newValue;
        } else if (parseInt(inputValue) < parseInt(productQuantity)) {
            newValue = parseInt(productQuantity) - parseInt(inputValue);
            newTotalProduct = parseInt(totalProduct) + newValue;
        } else {
            newTotalProduct = totalProduct;
        }

        console.log(productId, productName, productImage, productPrice, productQuantity, productPrice * productQuantity, newTotalProduct, inputValue);
         // Check if inputValue is not a number or is empty
		 if (isNaN(inputValue) || inputValue.trim().length === 0) {
            alert("Please enter a valid number for quantity");
            // Tránh cố gắng cập nhật cart nếu có lỗi
            return;
        }
        if (parseInt(inputValue) < 1) {
            alert("Number input must be greater than 0");
            // Tránh cố gắng cập nhật cart nếu có lỗi
            return;
        }
        if (parseInt(inputValue) > (parseInt(totalProduct) + parseInt(productQuantity))) {
            alert("Total product not enough");
            // Tránh cố gắng cập nhật cart nếu có lỗi
            return;
        }

        var item = {
            productId: productId,
            productName: productName,
            productImage: productImage,
            productPrice: productPrice,
            productQuantity: inputValue,
            productTotalPrice: productPrice * inputValue,
            newTotalProduct: newTotalProduct
        };

        cartItems.push(item);
    });

    console.log(cartItems);

    $.ajax({
        url: '../controller/update_cart.php',
        method: 'POST',
        data: { cartItems: JSON.stringify(cartItems) },
        success: function (data) {
            alert("Updated cart successfully");
            location.reload();
        },
        error: function (error) {
            console.error("Error updating cart", error);
        }
    });
});
$(".remove-btn").click(function(e) {
    e.preventDefault();
    var $this = $(this);
    var id = $this.data("id");
    var productId = $this.data("productid");
    var productQty = $this.data("productquantity");
    var cartQty = parseInt($this.data("cartqty"));
    var rootQty = parseInt(productQty) + parseInt(cartQty);
    console.log(productQty,productId,cartQty,rootQty);
    swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: '../controller/delete.php',
          method: 'post',
          data: {remove: id,rootQty:rootQty,id:productId},
          success: function(response){  
            Swal.fire(
              'Deleted!',
              'Your file has been deleted.',
              'success'
            ).then(() => {
              location.reload(); // Tải lại trang sau khi xóa thành công
            });
          },
          error: function(xhr, status, error) {
            console.error("Lỗi khi xóa sản phẩm:", error);
          }
        });
      }
    });
  });
  $(".remove-all").click(function(e) {
  e.preventDefault();
  // Mảng chứa thông tin các mục cần xóa
  var itemsToRemove = [];  
  $(".productQty").each(function() {
    var $this = $(this);
    var cartQty = $this.closest('tr').find('.input-num').val();
    // Lấy thông tin mỗi mục
    var item = {
      id: $this.closest('tr').find('.product_id').val(),  
      qty: parseInt($this.val()),
      cartQty: parseInt(cartQty) // thêm cartQty vào
    }; 
    // Thêm vào mảng để xóa
    itemsToRemove.push(item);
  });
  console.log(itemsToRemove);
  // Gọi AJAX
  swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete all!'
    }).then((result) => {
        if (result.isConfirmed) {
        $.ajax({
          url: '../controller/delete-all.php',
          method: 'post',
          data: {items:JSON.stringify(itemsToRemove)},
          success: function(response){  
            Swal.fire(
              'Deleted!',
              'Your file has been deleted.',
              'success'
            ).then(() => {
              location.reload(); // Tải lại trang sau khi xóa thành công
            });
          },
          error: function(xhr, status, error) {
            console.error("Lỗi khi xóa sản phẩm:", error);
          }
        });
      }
});
});
<?php if(isset($_SESSION['success'])):?>
	alertify.set('notifier','position', 'top-right');
    alertify.success('<p style="color:white;"><?php echo $_SESSION['success']; ?></p>');
 <?php unset($_SESSION['success']);?>
<?php endif;?>
<?php if(isset($_SESSION['notice'])):?>
	alertify.set('notifier','position', 'top-right');
    alertify.success('<p style="color:white;"><?php echo $_SESSION['notice']; ?></p>');
 <?php unset($_SESSION['notice']);?>
<?php endif;?>
<?php if(isset($_SESSION['noticeUpdate'])):?>
	alertify.set('notifier','position', 'top-right');
    alertify.success('<p style="color:white;"><?php echo $_SESSION['noticeUpdate']; ?></p>');
 <?php unset($_SESSION['noticeUpdate']);?>
<?php endif;?>
</script>
</body>
</html>